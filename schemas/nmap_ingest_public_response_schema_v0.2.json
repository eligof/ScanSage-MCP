{
  "type": "object",
  "required": [
    "operation",
    "ingest_id",
    "format",
    "summary",
    "findings",
    "next_steps",
    "parser_version",
    "findings_count",
    "parsed_findings"
  ],
  "properties": {
    "operation": {
      "type": "string",
      "const": "nmap_ingest"
    },
    "ingest_id": {
      "type": "string",
      "minLength": 8,
      "maxLength": 128
    },
    "format": {
      "type": "string",
      "enum": ["nmap_xml", "synthetic_v1"]
    },
    "summary": {
      "type": "object",
      "required": ["payload_bytes", "payload_sha256", "parsed"],
      "properties": {
        "payload_bytes": {
          "type": "integer",
          "minimum": 1
        },
        "payload_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "parsed": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "findings": {
      "type": "array",
      "items": {
        "type": "object"
      },
      "maxItems": 1000
    },
    "next_steps": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "maxItems": 50
    },
    "parser_version": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64
    },
    "findings_count": {
      "type": "integer",
      "minimum": 0
    },
    "parsed_findings": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/nmap_parsed_finding"
      },
      "maxItems": 100
    },
    "metadata": {
      "type": "object",
      "properties": {
        "caps": {
          "type": "object",
          "required": ["capped", "cap_reason", "limits"],
          "properties": {
            "capped": {
              "type": "boolean"
            },
            "cap_reason": {
              "type": "string",
              "enum": ["MAX_HOSTS", "MAX_PORTS", "MAX_FINDINGS"]
            },
            "limits": {
              "type": "object",
              "required": ["max_hosts", "max_ports_per_host", "max_findings"],
              "properties": {
                "max_hosts": {
                  "type": "integer",
                  "minimum": 1
                },
                "max_ports_per_host": {
                  "type": "integer",
                  "minimum": 1
                },
                "max_findings": {
                  "type": "integer",
                  "minimum": 1
                }
              },
              "additionalProperties": false
            },
            "counts": {
              "type": "object",
              "properties": {
                "hosts_processed": {
                  "type": "integer",
                  "minimum": 0
                },
                "ports_processed": {
                  "type": "integer",
                  "minimum": 0
                },
                "findings_processed": {
                  "type": "integer",
                  "minimum": 0
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
    "definitions": {
      "nmap_parsed_finding": {
      "$comment": "Parsed finding objects only expose title/detail/confidence.",
      "type": "object",
      "required": ["title", "detail", "confidence"],
      "properties": {
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 128
        },
        "detail": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256
        },
        "confidence": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
